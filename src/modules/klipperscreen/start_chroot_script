#!/bin/bash

# Script d'installation automatique de KlipperScreen
# Ce script est destiné à fonctionner sur des distributions basées sur Debian (Raspberry Pi OS, Ubuntu Server, etc.)

# 1. Mettre à jour le système
echo "Mise à jour des paquets du système..."
sudo apt-get update && sudo apt-get upgrade -y

# 2. Installer les dépendances nécessaires
echo "Installation des dépendances..."
sudo apt-get install -y python3 python3-virtualenv python3-dev libffi-dev libjpeg-dev libfreetype6-dev \
                    build-essential libopenjp2-7 libtiff5 fonts-freefont-ttf git xinit xorg \
                    libdrm-dev

# 3. Cloner le dépôt KlipperScreen
echo "Clonage du dépôt KlipperScreen..."
cd ~
git clone https://github.com/jordanruthe/KlipperScreen.git

# 4. Créer et activer un environnement virtuel Python pour KlipperScreen
echo "Création d'un environnement virtuel pour KlipperScreen..."
cd KlipperScreen
python3 -m venv venv
source venv/bin/activate

# 5. Installer les dépendances Python de KlipperScreen
echo "Installation des dépendances Python..."
pip install -r requirements.txt

# 6. Définir les permissions pour la connexion à l'écran
echo "Configuration des permissions pour l'accès à l'écran..."
sudo usermod -a -G tty pi  # Remplacez 'pi' par votre nom d'utilisateur si nécessaire
sudo usermod -a -G video pi

# 7. Configurer le service systemd pour KlipperScreen
echo "Création du service KlipperScreen dans systemd..."
cat << EOF | sudo tee /etc/systemd/system/klipperscreen.service
[Unit]
Description=KlipperScreen
After=display-manager.service
Wants=display-manager.service

[Service]
Type=simple
User=pi
ExecStart=/home/pi/KlipperScreen/scripts/KlipperScreen
Environment="DISPLAY=:0"
Environment="XAUTHORITY=/home/pi/.Xauthority"
WorkingDirectory=/home/pi/KlipperScreen
StandardOutput=inherit
StandardError=inherit
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 8. Activer et démarrer le service KlipperScreen
echo "Activation et démarrage du service KlipperScreen..."
sudo systemctl enable klipperscreen.service
sudo systemctl start klipperscreen.service

echo "Installation terminée ! KlipperScreen devrait maintenant fonctionner sur votre écran."
